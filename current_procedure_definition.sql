CREATE DEFINER=`awsmaster`@`%` PROCEDURE `GetCompleteBoatInformation`( IN p_hull_no VARCHAR(20) )
proc_label: BEGIN DECLARE v_boat_item_no VARCHAR(14) DEFAULT NULL; DECLARE v_dealer_number VARCHAR(10); DECLARE v_dealer_name VARCHAR(200); DECLARE v_series VARCHAR(5); DECLARE v_model_year INT; DECLARE v_invoice_no VARCHAR(30); DECLARE v_invoice_date_yyyymmdd VARCHAR(8); DECLARE v_erp_order_no VARCHAR(30); DECLARE v_boat_description VARCHAR(100); DECLARE v_series_column_prefix VARCHAR(10); DECLARE v_dealer_id_normalized VARCHAR(10); DECLARE v_table_name VARCHAR(50); SELECT BoatItemNo, DealerNumber, DealerName, Series, SN_MY, InvoiceNo, InvoiceDateYYYYMMDD, ERP_OrderNo, BoatDesc1 INTO v_boat_item_no, v_dealer_number, v_dealer_name, v_series, v_model_year, v_invoice_no, v_invoice_date_yyyymmdd, v_erp_order_no, v_boat_description FROM warrantyparts.SerialNumberMaster WHERE Boat_SerialNo = p_hull_no LIMIT 1; IF v_boat_item_no IS NULL THEN SELECT 'ERROR' as status, CONCAT('Hull number not found: ', p_hull_no) as message; LEAVE proc_label; END IF; SELECT p_hull_no as hull_serial_no, snm.BoatItemNo as model_no, snm.BoatDesc1 as model_description, snm.BoatDesc2 as model_description_2, snm.Series as series, snm.SN_MY as model_year, snm.SerialModelYear as serial_model_year, snm.DealerNumber as dealer_id, snm.DealerName as dealer_name, snm.DealerCity as dealer_city, snm.DealerState as dealer_state, snm.DealerZip as dealer_zip, snm.DealerCountry as dealer_country, snm.InvoiceNo as invoice_no, snm.InvoiceDateYYYYMMDD as invoice_date_yyyymmdd, snm.ERP_OrderNo as erp_order_no, snm.WebOrderNo as web_order_no, snm.PanelColor as panel_color, snm.AccentPanel as accent_panel, snm.TrimAccent as trim_accent, snm.BaseVinyl as base_vinyl, snm.ColorPackage as color_package, snm.ParentRepName as rep_name, snm.Presold as presold, snm.Active as active FROM warrantyparts.SerialNumberMaster snm WHERE snm.Boat_SerialNo = p_hull_no; SET v_table_name = CONCAT('BoatOptions', v_model_year); DROP TEMPORARY TABLE IF EXISTS tmp_line_items; CREATE TEMPORARY TABLE tmp_line_items ( line_no INT, item_no VARCHAR(30), item_desc VARCHAR(255), product_category VARCHAR(10), quantity INT, ext_sales_amount DECIMAL(10,2) ); SET @query = CONCAT(' INSERT INTO tmp_line_items SELECT LineNo as line_no, ItemNo as item_no, ItemDesc1 as item_desc, ItemMasterProdCat as product_category, QuantitySold as quantity, ExtSalesAmount as ext_sales_amount FROM warrantyparts.', v_table_name, ' WHERE BoatSerialNo = ? ORDER BY LineNo '); PREPARE stmt FROM @query; SET @hull_param = p_hull_no; EXECUTE stmt USING @hull_param; DEALLOCATE PREPARE stmt; SELECT line_no, item_no, item_desc, product_category, quantity, ext_sales_amount, CASE product_category WHEN 'BS1' THEN 'Base Boat' WHEN 'EN7' THEN 'Engine' WHEN 'ACC' THEN 'Accessories' WHEN 'ENG' THEN 'Engine Related' WHEN 'MTR' THEN 'Motor' WHEN 'H1' THEN 'Colors/Options' WHEN 'L2' THEN 'Labor' WHEN 'C1L' THEN 'Discounts' WHEN 'GRO' THEN 'Fees' ELSE product_category END as category_name, v_table_name as source_table FROM tmp_line_items ORDER BY line_no; DROP TEMPORARY TABLE IF EXISTS tmp_msrp_summary; CREATE TEMPORARY TABLE tmp_msrp_summary ( category VARCHAR(50), category_code VARCHAR(10), msrp DECIMAL(10,2) ); INSERT INTO tmp_msrp_summary SELECT 'Base Boat', 'BS1', COALESCE(SUM(CASE WHEN product_category = 'BS1' THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'Engine', 'EN7', COALESCE(SUM(CASE WHEN product_category IN ('EN7', 'ENG', 'MTR') THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'Accessories', 'ACC', COALESCE(SUM(CASE WHEN product_category = 'ACC' THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'Colors/Options', 'H1', COALESCE(SUM(CASE WHEN product_category = 'H1' THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'Labor/Prep', 'L2', COALESCE(SUM(CASE WHEN product_category = 'L2' THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'Discounts', 'C1L', COALESCE(SUM(CASE WHEN product_category = 'C1L' THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'Fees', 'GRO', COALESCE(SUM(CASE WHEN product_category = 'GRO' THEN ext_sales_amount END), 0) FROM tmp_line_items; INSERT INTO tmp_msrp_summary SELECT 'TOTAL', 'TOTAL', COALESCE(SUM(ext_sales_amount), 0) FROM tmp_line_items; SELECT * FROM tmp_msrp_summary; SET v_dealer_id_normalized = CAST(v_dealer_number AS UNSIGNED); SET v_series_column_prefix = CASE WHEN v_series = 'S' THEN 'S_23' WHEN v_series = 'SV' THEN 'SV_23' ELSE v_series END; SET @margin_query = CONCAT(' SELECT DealerID as dealer_id, Dealership as dealer_name, ''', v_series, ''' as series, ''', v_series_column_prefix, ''' as column_prefix, `', v_series_column_prefix, '_BASE_BOAT` as base_boat_margin_pct, `', v_series_column_prefix, '_ENGINE` as engine_margin_pct, `', v_series_column_prefix, '_OPTIONS` as options_margin_pct, `', v_series_column_prefix, '_FREIGHT` as freight_value, `', v_series_column_prefix, '_PREP` as prep_value, `', v_series_column_prefix, '_VOL_DISC` as volume_discount_pct, ''warrantyparts.DealerMargins'' as data_source FROM warrantyparts.DealerMargins WHERE CAST(DealerID AS UNSIGNED) = ? LIMIT 1 '); DROP TEMPORARY TABLE IF EXISTS tmp_margins; CREATE TEMPORARY TABLE tmp_margins ( dealer_id VARCHAR(10), dealer_name VARCHAR(255), series VARCHAR(5), column_prefix VARCHAR(10), base_boat_margin_pct DECIMAL(10,2), engine_margin_pct DECIMAL(10,2), options_margin_pct DECIMAL(10,2), freight_value DECIMAL(10,2), prep_value DECIMAL(10,2), volume_discount_pct DECIMAL(10,2), data_source VARCHAR(50) ); PREPARE margin_stmt FROM @margin_query; SET @dealer_param = v_dealer_id_normalized; EXECUTE margin_stmt USING @dealer_param; DEALLOCATE PREPARE margin_stmt; SELECT dealer_id, dealer_name, series, base_boat_margin_pct, engine_margin_pct, options_margin_pct, freight_value, CASE WHEN freight_value > 100 THEN 'FIXED_AMOUNT' ELSE 'PERCENTAGE' END as freight_type, prep_value, CASE WHEN prep_value > 100 THEN 'FIXED_AMOUNT' ELSE 'PERCENTAGE' END as prep_type, volume_discount_pct, data_source FROM tmp_margins; SELECT msrp.category, msrp.category_code, msrp.msrp, CASE msrp.category_code WHEN 'BS1' THEN m.base_boat_margin_pct WHEN 'EN7' THEN m.engine_margin_pct WHEN 'ACC' THEN m.options_margin_pct WHEN 'H1' THEN m.options_margin_pct ELSE 0 END as margin_pct, CASE msrp.category_code WHEN 'BS1' THEN ROUND(msrp.msrp * (1 - m.base_boat_margin_pct/100), 2) WHEN 'EN7' THEN ROUND(msrp.msrp * (1 - m.engine_margin_pct/100), 2) WHEN 'ACC' THEN ROUND(msrp.msrp * (1 - m.options_margin_pct/100), 2) WHEN 'H1' THEN ROUND(msrp.msrp * (1 - m.options_margin_pct/100), 2) WHEN 'L2' THEN msrp.msrp WHEN 'C1L' THEN msrp.msrp WHEN 'GRO' THEN msrp.msrp WHEN 'TOTAL' THEN ( SELECT ROUND(SUM( CASE WHEN category_code = 'BS1' THEN msrp * (1 - m.base_boat_margin_pct/100) WHEN category_code = 'EN7' THEN msrp * (1 - m.engine_margin_pct/100) WHEN category_code IN ('ACC', 'H1') THEN msrp * (1 - m.options_margin_pct/100) ELSE msrp END ), 2) FROM ( SELECT 'BS1' as category_code, COALESCE(SUM(CASE WHEN product_category = 'BS1' THEN ext_sales_amount END), 0) as msrp FROM tmp_line_items UNION ALL SELECT 'EN7', COALESCE(SUM(CASE WHEN product_category IN ('EN7', 'ENG', 'MTR') THEN ext_sales_amount END), 0) FROM tmp_line_items UNION ALL SELECT 'ACC', COALESCE(SUM(CASE WHEN product_category = 'ACC' THEN ext_sales_amount END), 0) FROM tmp_line_items UNION ALL SELECT 'H1', COALESCE(SUM(CASE WHEN product_category = 'H1' THEN ext_sales_amount END), 0) FROM tmp_line_items UNION ALL SELECT 'L2', COALESCE(SUM(CASE WHEN product_category = 'L2' THEN ext_sales_amount END), 0) FROM tmp_line_items UNION ALL SELECT 'C1L', COALESCE(SUM(CASE WHEN product_category = 'C1L' THEN ext_sales_amount END), 0) FROM tmp_line_items UNION ALL SELECT 'GRO', COALESCE(SUM(CASE WHEN product_category = 'GRO' THEN ext_sales_amount END), 0) FROM tmp_line_items ) calc ) ELSE msrp.msrp END as dealer_cost, CASE msrp.category_code WHEN 'BS1' THEN ROUND(msrp.msrp * (m.base_boat_margin_pct/100), 2) WHEN 'EN7' THEN ROUND(msrp.msrp * (m.engine_margin_pct/100), 2) WHEN 'ACC' THEN ROUND(msrp.msrp * (m.options_margin_pct/100), 2) WHEN 'H1' THEN ROUND(msrp.msrp * (m.options_margin_pct/100), 2) WHEN 'TOTAL' THEN ( msrp.msrp - ( SELECT ROUND(SUM( CASE WHEN category_code = 'BS1' THEN msrp * (1 - m.base_boat_margin_pct/100) WHEN category_code = 'EN7' THEN msrp * (1 - m.engine_margin_pct/100) WHEN category_code IN ('ACC', 'H1') THEN msrp * (1 - m.options_margin_pct/100) ELSE msrp END ), 2) FROM tmp_msrp_summary calc ) ) ELSE 0 END as dealer_savings FROM tmp_msrp_summary msrp CROSS JOIN tmp_margins m; DROP TEMPORARY TABLE IF EXISTS tmp_line_items; DROP TEMPORARY TABLE IF EXISTS tmp_msrp_summary; DROP TEMPORARY TABLE IF EXISTS tmp_margins; END proc_label